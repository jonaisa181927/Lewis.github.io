<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Estructura de Lewis avanzada</title>
<style>
  body {
    background: #222;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 20px;
  }
  input, button {
    font-size: 1.2rem;
    padding: 5px 10px;
    border-radius: 8px;
    border: none;
    margin: 10px;
  }
  button {
    background-color: #0077cc;
    color: white;
    cursor: pointer;
  }
  canvas {
    background-color: #111;
    border-radius: 15px;
    margin-top: 20px;
  }
  #info {
    margin-top: 10px;
    font-size: 1.1rem;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
    text-align: left;
  }
</style>
</head>
<body>

<h1>Estructura de Lewis Avanzada</h1>
<input id="formula" type="text" placeholder="Ejemplo: AlF3, CaBr, H2SO3, NO, SO3" />
<button onclick="dibujar()">Dibujar</button>
<div id="info"></div>
<canvas id="canvas" width="700" height="450"></canvas>

<script>
// Valencias típicas para elementos comunes
const valencias = {
  H: 1, He: 2,
  Li: 1, Be: 2, B: 3, C: 4, N: 5, O: 6, F: 7, Ne: 8,
  Na: 1, Mg: 2, Al: 3, Si: 4, P: 5, S: 6, Cl: 7, Ar: 8,
  K: 1, Ca: 2, Br: 7, I: 7,
};

// Átomos que pueden tener menos de octeto (como Al)
const excepcionesOcteto = ['B', 'Al'];

function parseFormula(formula) {
  const regex = /([A-Z][a-z]?)(\d*)/g;
  const elementos = {};
  let match;
  while ((match = regex.exec(formula)) !== null) {
    const el = match[1];
    const cant = parseInt(match[2]) || 1;
    elementos[el] = (elementos[el] || 0) + cant;
  }
  return elementos;
}

function elegirCentral(elementos) {
  // Regla simplificada:
  // 1) Si C, es central
  // 2) Si no, Si o P o S
  // 3) Si no, menos electronegativo y no H
  if ('C' in elementos) return 'C';
  if ('Si' in elementos) return 'Si';
  if ('P' in elementos) return 'P';
  if ('S' in elementos) return 'S';

  const sinH = Object.keys(elementos).filter(e => e !== 'H');
  if (sinH.length === 0) return 'H';

  // Menor electronegatividad (simplificado)
  // Orden común electronegativos (de menos a más):
  const electronegatividad = {
    'Li': 1.0, 'Be': 1.5, 'B': 2.0, 'C': 2.5, 'N': 3.0, 'O': 3.5, 'F': 4.0,
    'Na': 0.9, 'Mg': 1.2, 'Al': 1.5, 'Si': 1.8, 'P': 2.1, 'S': 2.5, 'Cl': 3.0,
    'K': 0.8, 'Ca': 1.0, 'Br': 2.8, 'I': 2.5
  };

  sinH.sort((a,b) => (electronegatividad[a]||2.5) - (electronegatividad[b]||2.5));
  return sinH[0];
}

function totalElectronesValencia(elementos) {
  let total = 0;
  for (const el in elementos) {
    const val = valencias[el] || 0;
    total += val * elementos[el];
  }
  return total;
}

function dibujarAtomo(ctx, simbolo, x, y, radio) {
  ctx.fillStyle = 'black';
  ctx.strokeStyle = 'white';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.arc(x, y, radio, 0, 2 * Math.PI);
  ctx.fill();
  ctx.stroke();

  ctx.fillStyle = 'white';
  ctx.font = `${radio}px Arial`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(simbolo, x, y);
}

function dibujarEnlace(ctx, x1, y1, x2, y2, grosor = 3) {
  ctx.strokeStyle = 'white';
  ctx.lineWidth = grosor;
  ctx.beginPath();
  ctx.moveTo(x1, y1);
  ctx.lineTo(x2, y2);
  ctx.stroke();
}

function dibujarPuntos(ctx, x, y, electrones, radio = 55) {
  if (electrones <= 0) return;
  const anguloSep = (2 * Math.PI) / electrones;
  ctx.fillStyle = 'yellow';
  ctx.strokeStyle = 'orange';
  ctx.lineWidth = 1;
  for (let i = 0; i < electrones; i++) {
    const angulo = -Math.PI / 2 + i * anguloSep;
    const px = x + radio * Math.cos(angulo);
    const py = y + radio * Math.sin(angulo);
    ctx.beginPath();
    ctx.arc(px, py, 6, 0, 2 * Math.PI);
    ctx.fill();
    ctx.stroke();
  }
}

function dibujar() {
  const formulaInput = document.getElementById('formula').value.trim();
  const info = document.getElementById('info');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  info.textContent = '';

  if (!formulaInput) {
    info.textContent = 'Por favor ingresa una fórmula química válida.';
    return;
  }

  const elementos = parseFormula(formulaInput);
  if (Object.keys(elementos).length === 0) {
    info.textContent = 'Fórmula no válida o no reconocida.';
    return;
  }

  // Elegir átomo central y separar ligandos
  const central = elegirCentral(elementos);
  let ligandos = [];
  for (const el in elementos) {
    if (el !== central) {
      for (let i=0; i < elementos[el]; i++) ligandos.push(el);
    }
  }

  info.innerHTML = `<b>Átomo central:</b> ${central} <br><b>Ligandos:</b> ${ligandos.join(', ') || 'Ninguno'}`;

  // Variables para dibujar
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const radioCentral = 50;

  // Calcular electrones totales de valencia
  let totalValencia = totalElectronesValencia(elementos);

  // Enlaces: inicialmente simple enlace por ligando
  const electronesPorEnlace = 2;
  let totalEnlaces = ligandos.length;

  // Excepciones: Al y B pueden tener 6 e- (3 enlaces)
  const esExcepcion = excepcionesOcteto.includes(central);

  // Dibuja átomo central
  dibujarAtomo(ctx, central, cx, cy, radioCentral);

  // Calcular electrones enlazantes y libres central
  // Para excepciones: permiten menos electrones libres (ej: Al = 6)
  let maxElectronesCentral = esExcepcion ? 6 : 8;

  // Enlaces * 2 electrones por enlace
  let electronesEnlacesCentral = totalEnlaces * electronesPorEnlace;
  if (electronesEnlacesCentral > maxElectronesCentral) electronesEnlacesCentral = maxElectronesCentral;

  // Electrones libres central
  let electronesLibresCentral = maxElectronesCentral - electronesEnlacesCentral;
  if (electronesLibresCentral < 0) electronesLibresCentral = 0;

  dibujarPuntos(ctx, cx, cy, electronesLibresCentral, radioCentral + 15);

  // Dibujar ligandos alrededor
  const radioOrbital = 150;
  const n = ligandos.length;
  const anguloSep = n > 0 ? (2 * Math.PI) / n : 0;

  ligandos.forEach((lig, i) => {
    const angulo = -Math.PI / 2 + i * anguloSep;
    const x = cx + radioOrbital * Math.cos(angulo);
    const y = cy + radioOrbital * Math.sin(angulo);

    // Dibuja enlace simple
    dibujarEnlace(ctx, cx, cy, x, y);

    // Dibuja átomo ligando
    dibujarAtomo(ctx, lig, x, y, 35);

    // Electrones libres en ligando = valencia - 2 (enlace simple)
    const valLig = valencias[lig] || 0;
    let libresLig = valLig - 2;
    if (libresLig < 0) libresLig = 0;
    dibujarPuntos(ctx, x, y, libresLig, 40);
  });

  // Nota para moléculas con electrones impares (como NO)
  if (totalValencia % 2 !== 0) {
    info.innerHTML += '<br><b>Nota:</b> Molécula con número impar de electrones (radical), no cumple octeto exacto.';
  }
}
</script>

</body>
</html>
